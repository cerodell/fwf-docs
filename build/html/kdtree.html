
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Datasets</title>
    
  <link rel="stylesheet" href="_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.c441f2ba0852f4cabcb80105e3a46ae6.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    
  <link rel="preload" as="script" href="_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Website" href="web.html" />
    <link rel="prev" title="General" href="view.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logo-v4.png" class="logo" alt="logo">
  
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent">
 <span class="caption-text">
  Model:
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="view.html">
   General
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="web.html">
   Website
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ms.html">
   Structure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="api.html">
   API
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/kdtree.ipynb.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-domains">
   Model Domains
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#description">
     Description
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-variables">
     Dataset Variables
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#working-with">
   Working with
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-search-the-fwf-data-set-by-locations">
   How to search the FWF data set by locations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-dataset-information">
     Define dataset information
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-to-build-a-kdtree">
     Set up to build a kdtree
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-a-kdtree-and-save">
     Build a kdtree and save
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#search-the-data">
     Search the data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#index-an-entire-dataset">
     Index an entire dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-license">
   Data License
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="datasets">
<h1>Datasets<a class="headerlink" href="#datasets" title="Permalink to this headline">¶</a></h1>
<p>The Datasets are divided up by their model domain</p>
<div class="section" id="model-domains">
<h2>Model Domains<a class="headerlink" href="#model-domains" title="Permalink to this headline">¶</a></h2>
<p>The FWF model resolves the FWI System/ FBP System in the D02 (12 km) and D03 (4 km) at 55 hour forecast horizon.</p>
<p><img alt="title" src="_images/fwf-model-domains.png" /></p>
<div class="section" id="description">
<h3>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p>For each domain there are two <code class="docutils literal notranslate"><span class="pre">.nc</span></code> (netcdf) files generated, four total datasets each day.</p>
<p><strong>Domain: d02 (12 km)</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fwf-hourly-d02-YYYYMMDDHH.nc</span></code></p>
<ul>
<li><p>File Size: ~ 780M</p></li>
<li><p>File Dimensions: (time: 55, south_north: 417, west_east: 627)</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">fwf-daily-d02-YYYYMMDDHH.nc</span></code></p>
<ul>
<li><p>File Size: ~ 16M</p></li>
<li><p>File Dimensions: (time: 2, south_north: 417, west_east: 627)</p></li>
</ul>
</li>
</ul>
<p><strong>Domain: d03 (4 km)</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fwf-hourly-d03-YYYYMMDDHH.nc</span></code></p>
<ul>
<li><p>File Size:  ~ 1.7G</p></li>
<li><p>File Dimensions: (time: 55, south_north: 840, west_east: 642)</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">fwf-daily-d03-YYYYMMDDHH.nc</span></code></p>
<ul>
<li><p>File Size: ~ 30M</p></li>
<li><p>File Dimensions: (time: 2, south_north: 840, west_east: 642)</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="dataset-variables">
<h3>Dataset Variables<a class="headerlink" href="#dataset-variables" title="Permalink to this headline">¶</a></h3>
<p>Regardless of Domain, each dataset hourly/daily contain the following variables.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Hourly Dataset <br> <code class="docutils literal notranslate"><span class="pre">fwf-hourly-&lt;domain&gt;-YYYYMMDDHH.nc</span></code></p></th>
<th class="head"><p>Daily Dataset <br> <code class="docutils literal notranslate"><span class="pre">fwf-daily-&lt;domain&gt;--YYYYMMDDHH.nc</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Time</strong>: Hourly UTC</p></td>
<td><p><strong>Time</strong>: Noon Local for that Day</p></td>
</tr>
<tr class="row-odd"><td><p><strong>XLAT</strong>: Degrees Latitude</p></td>
<td><p><strong>XLAT</strong>: Degrees Latitude</p></td>
</tr>
<tr class="row-even"><td><p><strong>XLON</strong>: Degrees Longitude</p></td>
<td><p><strong>XLON</strong>: Degrees Longitude</p></td>
</tr>
<tr class="row-odd"><td><p><strong>F</strong>: Fine Fuel Moisture Code</p></td>
<td><p><strong>P</strong>: Duff Moisture Code</p></td>
</tr>
<tr class="row-even"><td><p><strong>m_o</strong>: Fine Fuel Moisture Content</p></td>
<td><p><strong>D</strong>: Drought Moisture Code</p></td>
</tr>
<tr class="row-odd"><td><p><strong>R</strong>: Initial Spread Index</p></td>
<td><p><strong>U</strong>: Build Up Index</p></td>
</tr>
<tr class="row-even"><td><p><strong>S</strong>: Fire Weather Index</p></td>
<td><p><strong>T</strong>: 2 meter Temperature C</p></td>
</tr>
<tr class="row-odd"><td><p><strong>DSR</strong>: Daily Severity Rating</p></td>
<td><p><strong>TD</strong>: 2 meter Dew Point Temperature C</p></td>
</tr>
<tr class="row-even"><td><p><strong>FMC</strong>: Foliar Moisture Content %</p></td>
<td><p><strong>H</strong>: 2 meter Relative Humdity %</p></td>
</tr>
<tr class="row-odd"><td><p><strong>SFC</strong>: Surface Fuel Consumption kg m^{-2}</p></td>
<td><p><strong>W</strong>: 10 meter Wind Speed km/h</p></td>
</tr>
<tr class="row-even"><td><p><strong>TFC</strong>: Total Fuel Consumption kg m^{-2}</p></td>
<td><p><strong>WD</strong>: 10 meter Wind Direction deg</p></td>
</tr>
<tr class="row-odd"><td><p><strong>ROS</strong>: Rate of Spread m min^{-1}</p></td>
<td><p><strong>r_o</strong>: Total Accumulated Precipitation mm</p></td>
</tr>
<tr class="row-even"><td><p><strong>CFB</strong>: Crown Fraction Burned %</p></td>
<td><p><strong>r_o_tomorrow</strong>: Carry Over Precipitation mm</p></td>
</tr>
<tr class="row-odd"><td><p><strong>HFI</strong>: Head Fire Intensity  kW m^{-1}</p></td>
<td><p><strong>SNOWC</strong>: Flag Inidicating Snow <br> Cover (1 for Snow Cover) Snow Depth m</p></td>
</tr>
<tr class="row-even"><td><p><strong>T</strong>: 2 meter Temperature C</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>TD</strong>: 2 meter Dew Point Temperature C</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>H</strong>: 2 meter Relative Humdity %</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>W</strong>: 10 meter Wind Speed km/h</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>WD</strong>: 10 meter Wind Direction deg</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>U10</strong>:  U Component of Wind at 10 meter m/s</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>V10</strong>: V Component of Wind at 10 meter m/s</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>r_o</strong>: Total Accumulated Precipitation mm</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>r_o_hourly</strong>: Hourly Accumulated Precipitation mm</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>SNW</strong>: Total Accumulated Snow cm</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>SNOWH</strong>: Physical Snow Depth m</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><strong>SNOWC</strong>: Flag Indicating Snow <br> Cover (1 for Snow Cover) Snow Depth m</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="working-with">
<h2>Working with<a class="headerlink" href="#working-with" title="Permalink to this headline">¶</a></h2>
<p>Suggest using <a class="reference external" href="http://xarray.pydata.org/en/stable/">xarray</a> to open and work with data.</p>
<p>An example of how to open and view</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">context</span> <span class="kn">import</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">fwf_dir</span>

<span class="n">forecast_date</span> <span class="o">=</span> <span class="s1">&#39;2021051006&#39;</span>  <span class="c1">## &quot;YYYYMMDDHH&quot;</span>
<span class="n">domain</span>        <span class="o">=</span> <span class="s1">&#39;d02&#39;</span>         <span class="c1">## or &#39;d03&#39;</span>
<span class="n">name</span> 	        <span class="o">=</span> <span class="s1">&#39;hourly&#39;</span>      <span class="c1">## or &#39;daily&#39;</span>

<span class="c1">## file directory</span>
<span class="n">filein</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fwf_dir</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/fwf-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">forecast_date</span><span class="si">}</span><span class="s2">.nc&quot;</span>

<span class="c1">## open dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filein</span><span class="p">)</span>

<span class="c1">## chunk data to dask.arrays </span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">unify_chunks</span><span class="p">()</span>
<span class="c1"># NOTE this is not needed. Arrays will be either numpy float32 or objects</span>

<span class="c1">## Example: look at variable F (Fine Fuels Moisture Code)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>******************************
context imported. Front of path:
/Users/rodell/fwf
/Users/rodell/fwf/fwf-docs/source
******************************

through /Users/rodell/fwf/fwf-docs/source/context.py -- pha
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;F&#39; (time: 55, south_north: 417, west_east: 627)&gt;
dask.array&lt;xarray-F, shape=(55, 417, 627), dtype=float32, chunksize=(55, 417, 627), chunktype=numpy.ndarray&gt;
Coordinates:
    XLONG    (south_north, west_east) float32 dask.array&lt;chunksize=(417, 627), meta=np.ndarray&gt;
    XLAT     (south_north, west_east) float32 dask.array&lt;chunksize=(417, 627), meta=np.ndarray&gt;
    XTIME    (time) float32 dask.array&lt;chunksize=(55,), meta=np.ndarray&gt;
    Time     (time) datetime64[ns] dask.array&lt;chunksize=(55,), meta=np.ndarray&gt;
Dimensions without coordinates: time, south_north, west_east
Attributes:
    FieldType:    104
    MemoryOrder:  XY 
    description:  FINE FUEL MOISTURE CODE
    projection:   PolarStereographic(stand_lon=-110.0, moad_cen_lat=53.999992...
    stagger:      
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-search-the-fwf-data-set-by-locations">
<h2>How to search the FWF data set by locations<a class="headerlink" href="#how-to-search-the-fwf-data-set-by-locations" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KDTree</span>


<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">context</span> <span class="kn">import</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">fwf_dir</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="define-dataset-information">
<h3>Define dataset information<a class="headerlink" href="#define-dataset-information" title="Permalink to this headline">¶</a></h3>
<p>Define forecast date, domain and set paths to dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_date</span> <span class="o">=</span> <span class="s1">&#39;2021051006&#39;</span>  <span class="c1">## &quot;YYYYMMDDHH&quot;</span>
<span class="n">domain</span>        <span class="o">=</span> <span class="s1">&#39;d02&#39;</span>         <span class="c1">## or &#39;d03&#39;</span>
<span class="n">name</span> 	        <span class="o">=</span> <span class="s1">&#39;hourly&#39;</span>      <span class="c1">## or &#39;daily&#39;</span>

<span class="n">filein</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fwf_dir</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/fwf-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">forecast_date</span><span class="si">}</span><span class="s2">.nc&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Open forecast dataset and print</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filein</span><span class="p">)</span>
<span class="c1">## strip some attributes from the netcdf for the sake of printing</span>
<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TITLE&#39;</span><span class="p">:</span> <span class="s1">&#39;FWF MODEL USING OUTPUT FROM WRF V4.2.1 MODEL&#39;</span><span class="p">,</span>
 <span class="s1">&#39;WEST-EAST_GRID_DIMENSION&#39;</span><span class="p">:</span> <span class="s1">&#39;628&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SOUTH-NORTH_GRID_DIMENSION&#39;</span><span class="p">:</span> <span class="s1">&#39;418&#39;</span><span class="p">,</span>
 <span class="s1">&#39;DX&#39;</span><span class="p">:</span> <span class="s1">&#39;12000.0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;DY&#39;</span><span class="p">:</span> <span class="s1">&#39;12000.0&#39;</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:     (south_north: 417, time: 55, west_east: 627)
Coordinates:
    XLONG       (south_north, west_east) float32 ...
    XLAT        (south_north, west_east) float32 ...
    XTIME       (time) float32 ...
    Time        (time) datetime64[ns] ...
Dimensions without coordinates: south_north, time, west_east
Data variables:
    F           (time, south_north, west_east) float32 ...
    m_o         (time, south_north, west_east) float32 ...
    T           (time, south_north, west_east) float32 ...
    TD          (time, south_north, west_east) float32 ...
    H           (time, south_north, west_east) float32 ...
    W           (time, south_north, west_east) float32 ...
    WD          (time, south_north, west_east) float32 ...
    r_o         (time, south_north, west_east) float32 ...
    SNW         (time, south_north, west_east) float32 ...
    SNOWC       (time, south_north, west_east) float32 ...
    SNOWH       (time, south_north, west_east) float32 ...
    U10         (time, south_north, west_east) float32 ...
    V10         (time, south_north, west_east) float32 ...
    r_o_hourly  (time, south_north, west_east) float32 ...
    R           (time, south_north, west_east) float32 ...
    S           (time, south_north, west_east) float32 ...
    DSR         (time, south_north, west_east) float32 ...
    FMC         (south_north, west_east) float32 ...
    SFC         (time, south_north, west_east) float32 ...
    ISI         (time, south_north, west_east) float32 ...
    ROS         (time, south_north, west_east) float32 ...
    CFB         (time, south_north, west_east) float32 ...
    TFC         (time, south_north, west_east) float32 ...
    HFI         (time, south_north, west_east) float32 ...
Attributes:
    TITLE:                       FWF MODEL USING OUTPUT FROM WRF V4.2.1 MODEL
    WEST-EAST_GRID_DIMENSION:    628
    SOUTH-NORTH_GRID_DIMENSION:  418
    DX:                          12000.0
    DY:                          12000.0
</pre></div>
</div>
</div>
</div>
<p>Load a data set of weather sation locations and look at the first four rows as an example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/nrcan-wxstations.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wmo&#39;</span><span class="p">,</span>	<span class="s1">&#39;lat&#39;</span><span class="p">,</span>	<span class="s1">&#39;lon&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     wmo     lat      lon
0  70489  53.900 -166.533
1  70395  55.350 -131.700
2  70387  56.483 -132.367
3  70386  56.817 -132.967
4  70381  58.367 -134.583
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-up-to-build-a-kdtree">
<h3>Set up to build a kdtree<a class="headerlink" href="#set-up-to-build-a-kdtree" title="Permalink to this headline">¶</a></h3>
<p>First, set path to store kdtree and make directory if it doesn’t exist</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kdtree_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/kdtree/&quot;</span><span class="p">)</span>
<span class="n">kdtree_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now take gridded lats and long and convert to np arrays and check its shape</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XLAT</span><span class="p">,</span> <span class="n">XLONG</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">XLAT</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">XLONG</span><span class="o">.</span><span class="n">values</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">XLAT</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(417, 627)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="build-a-kdtree-and-save">
<h3>Build a kdtree and save<a class="headerlink" href="#build-a-kdtree-and-save" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
  <span class="c1">## try and open kdtree for domain</span>
  <span class="n">fwf_tree</span><span class="p">,</span> <span class="n">fwf_locs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kdtree_dir</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;fwf_</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1">_tree.p&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found FWF Tree&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
  <span class="c1">## build a kd-tree for fwf domain if not found</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find FWF KDTree building....&quot;</span><span class="p">)</span>
  <span class="c1">## create dataframe with columns of all lat/long in the domian...rows are cord pairs </span>
  <span class="n">fwf_locs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;XLAT&quot;</span><span class="p">:</span> <span class="n">XLAT</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="s2">&quot;XLONG&quot;</span><span class="p">:</span> <span class="n">XLONG</span><span class="o">.</span><span class="n">ravel</span><span class="p">()})</span>
  <span class="c1">## build kdtree</span>
  <span class="n">fwf_tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">fwf_locs</span><span class="p">)</span>
  <span class="c1">## save tree</span>
  <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">fwf_tree</span><span class="p">,</span> <span class="n">fwf_locs</span><span class="p">],</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kdtree_dir</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;fwf_</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1">_tree.p&#39;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FWF KDTree built&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found FWF Tree
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="search-the-data">
<h3>Search the data<a class="headerlink" href="#search-the-data" title="Permalink to this headline">¶</a></h3>
<p>With a built kdtree we can query the tree to find the nearest neighbor model grid to our locations of interest.</p>
<p>First, define empty list to append index of weather station locations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">south_north</span><span class="p">,</span>  <span class="n">west_east</span><span class="p">,</span> <span class="n">wmo</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<p>Now lets loop each weather station in dataframe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pandas&#39;</span><span class="p">):</span>
  <span class="c1">## arange wx station lat and long in a formate to query the kdtree</span>
  <span class="n">single_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loc</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">lon</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1">## query the kdtree retuning the distacne of nearest neighbor and the index on the raveled grid</span>
  <span class="n">fwf_dist</span><span class="p">,</span> <span class="n">fwf_ind</span> <span class="o">=</span> <span class="n">fwf_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">single_loc</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1">## set condition to pass on stations outside model domian </span>
  <span class="k">if</span> <span class="n">fwf_dist</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="k">pass</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1">## if condition passed reformate 1D index to 2D indexes</span>
    <span class="n">fwf_2D_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fwf_ind</span><span class="p">),</span> <span class="n">shape</span><span class="p">)</span>
    <span class="c1">## append the indexes to lists</span>
    <span class="n">wmo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">wmo</span><span class="p">)</span>
    <span class="n">south_north</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwf_2D_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">west_east</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwf_2D_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="index-an-entire-dataset">
<h3>Index an entire dataset<a class="headerlink" href="#index-an-entire-dataset" title="Permalink to this headline">¶</a></h3>
<p>Now the magic of xarray. Convert lists of indexes to dataarrays with dimension wmo (weather staton). This allows you to index an entire dataset!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">south_north</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">south_north</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span> <span class="s1">&#39;wmo&#39;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">wmo</span> <span class="o">=</span> <span class="n">wmo</span><span class="p">))</span>
<span class="n">west_east</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">west_east</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span> <span class="s1">&#39;wmo&#39;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">wmo</span> <span class="o">=</span> <span class="n">wmo</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Index the entire dataset at the locations of interest leaving dimension time with new dimension wx stations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_loc</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">south_north</span> <span class="o">=</span> <span class="n">south_north</span><span class="p">,</span> <span class="n">west_east</span> <span class="o">=</span> <span class="n">west_east</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Print to see new time series dataset at every weather station location</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ds_loc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:     (time: 55, wmo: 1335)
Coordinates:
    XLONG       (wmo) float32 -166.5 -131.7 -132.3 ... -76.06 -71.51 -69.85
    XLAT        (wmo) float32 53.95 55.29 56.45 56.77 ... 44.02 42.72 44.35
    XTIME       (time) float32 ...
    Time        (time) datetime64[ns] ...
  * wmo         (wmo) int64 70489 70395 70387 70386 ... 721847 721839 721829
Dimensions without coordinates: time
Data variables:
    F           (time, wmo) float32 ...
    m_o         (time, wmo) float32 ...
    T           (time, wmo) float32 ...
    TD          (time, wmo) float32 ...
    H           (time, wmo) float32 ...
    W           (time, wmo) float32 ...
    WD          (time, wmo) float32 ...
    r_o         (time, wmo) float32 ...
    SNW         (time, wmo) float32 ...
    SNOWC       (time, wmo) float32 ...
    SNOWH       (time, wmo) float32 ...
    U10         (time, wmo) float32 ...
    V10         (time, wmo) float32 ...
    r_o_hourly  (time, wmo) float32 ...
    R           (time, wmo) float32 ...
    S           (time, wmo) float32 ...
    DSR         (time, wmo) float32 ...
    FMC         (wmo) float32 ...
    SFC         (time, wmo) float32 ...
    ISI         (time, wmo) float32 ...
    ROS         (time, wmo) float32 ...
    CFB         (time, wmo) float32 ...
    TFC         (time, wmo) float32 ...
    HFI         (time, wmo) float32 ...
Attributes:
    TITLE:                       FWF MODEL USING OUTPUT FROM WRF V4.2.1 MODEL
    WEST-EAST_GRID_DIMENSION:    628
    SOUTH-NORTH_GRID_DIMENSION:  418
    DX:                          12000.0
    DY:                          12000.0
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-license">
<h2>Data License<a class="headerlink" href="#data-license" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License.</a></p>
</div>
</div>


              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="view.html" title="previous page">General</a>
    <a class='right-next' id="next-link" href="web.html" title="next page">Website</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Christopher Rodell<br/>
        
            &copy; Copyright 2020, Christopher Rodell.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>